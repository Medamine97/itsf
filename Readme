# Local Kubernetes Microservices with HTTPS Ingress

## 1. Create Local Kubernetes Cluster

```bash
# Create kind cluster
kind create cluster --name devops-cluster

# Install NGINX ingress controller
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml

# Wait for ingress controller
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=90s
```

## 2. Deploy RISF Service (Non-Root)

```bash
# Build and load image
docker build -f Dockerfile-risf -t risf-service:latest .
kind load docker-image risf-service:latest --name devops-cluster

# Deploy service
kubectl apply -f risf-deployment.yaml
```

## 3. Deploy ITSF Service (Non-Root)

```bash
# Create ConfigMap and deploy service
kubectl apply -f itsf-configmap.yaml
kubectl apply -f itsf-deployment.yaml
```

## 4. Generate PKI and TLS Certificates

```bash
# Setup PKI infrastructure
mkdir -p certs-new && cd certs-new

# Create Root CA
openssl genrsa -out ca.key 2048
openssl req -x509 -new -nodes \
  -key ca.key \
  -sha256 -days 365 \
  -out ca.crt \
  -subj "/CN=Local CA" \
  -addext "basicConstraints=critical,CA:TRUE"

# Generate RISF certificate
openssl genrsa -out hello-risf.key 2048
openssl req -new -x509 \
  -key hello-risf.key \
  -CA ca.crt \
  -CAkey ca.key \
  -CAcreateserial \
  -out hello-risf.crt \
  -days 365 \
  -sha256 \
  -subj "/CN=hello-risf.local.domain" \
  -addext "subjectAltName=DNS:hello-risf.local.domain" \
  -addext "keyUsage=digitalSignature,keyEncipherment" \
  -addext "extendedKeyUsage=serverAuth"

# Generate ITSF certificate
openssl genrsa -out hello-itsf.key 2048
openssl req -new -x509 \
  -key hello-itsf.key \
  -CA ca.crt \
  -CAkey ca.key \
  -CAcreateserial \
  -out hello-itsf.crt \
  -days 365 \
  -sha256 \
  -subj "/CN=hello-itsf.local.domain" \
  -addext "subjectAltName=DNS:hello-itsf.local.domain" \
  -addext "keyUsage=digitalSignature,keyEncipherment" \
  -addext "extendedKeyUsage=serverAuth"

# Create Kubernetes secrets
kubectl create secret tls hello-risf-tls --cert=hello-risf.crt --key=hello-risf.key
kubectl create secret tls hello-itsf-tls --cert=hello-itsf.crt --key=hello-itsf.key
```

## 5. Configure HTTPS Ingress

```bash
# Apply ingress configuration
kubectl apply -f ingress.yaml

# Configure local DNS
echo "127.0.0.1 hello-risf.local.domain hello-itsf.local.domain" | sudo tee -a /etc/hosts
```

## 6. Test HTTPS Access

```bash
# Test both services
curl -k https://hello-risf.local.domain
curl -k https://hello-itsf.local.domain
```

## Verification

```bash
# Check components status
kubectl get pods,svc,ingress
kubectl get secrets | grep tls

# Verify certificates
openssl verify -CAfile certs-new/ca.crt certs-new/hello-risf.crt
openssl verify -CAfile certs-new/ca.crt certs-new/hello-itsf.crt
```
